# Hyperledger Fabric v2 with Raft on Openshift

## Prerequisites

- Openshift cluster with at least 4GB memory and 2 vCPUs
- kubectl/oc available on path and configured to use a cluster
- Fabric binaries available on path

## Architechture

- Three peer orgs and two orderer orgs. Peer orgs too run an orderer each.
- Each org components are deployed in org's own namespace
- crypto materials generated by cryptogen
- crypto materials and channel-artifacts are mounted as k8s Secret
- Fabric CA stores data in Postgres (in this demo in sqlite)
- Fabric peer uses couchdb as state db. CouchDB is deployed in a separate pod (in this demo same pod as peer itself)

![hyperledger-fabric-network](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/blockchaind/hyperledger-fabric-v2-kubernetes-dev/master/network-diagram.puml)

## Network

Start

```bash
./hlf.sh up
```

Have peers joined to channel. Ensure all components are up and running.

```bash
./hlf.sh joinChannel
```

## Explorer

Start explorer db

```bash
kubectl -n org1 apply -f explorer/explorerdb.yaml
```

Start explorer. Ensure explorerdb is up and running.

```bash
kubectl -n org1 apply -f explorer/explorer.yaml
```

Access explorer UI

```bash
kubectl -n org1 port-forward svc/explorer 8080:80
```
explorer should now be available at http://localhost:8080

Chaincode lifecycle

```bash
./hlf.sh ccInstall
./hlf.sh ccApprove
./hlf.sh ccCommit
./hlf.sh ccInit             # Populates ledger with assests.
./hlf.sh ccQueryAllRes      # Reads ledger for every peer.
./hlf.sh ccQueryRe          # Reads the given RE id.
./hlf.sh ccCreateRe         # Creates a RE with given attributes.
./hlf.sh ccChangeReOwner    # Changes the owner of the given RE id.
./hlf.sh ccChangeRePrice    # Changes the price of the given RE id.
```

## Rest API

Start server

```bash
kubectl -n org1 apply -f api/api-k8s.yaml
```

port-forward API server once its in Running state

```bash
kubectl -n org1 expose svc/hlf-api
```
